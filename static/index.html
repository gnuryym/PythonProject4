<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Infinity ‚Äî —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--accent:#5B86E5;--muted:#666}
  body{font-family:Inter,Arial,sans-serif;background:var(--bg);margin:0;color:#111}
  header{height:76px;background:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 18px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  header .logo{font-weight:700;color:var(--accent)}
  main{padding:18px;max-width:1100px;margin:24px auto}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.04);margin-bottom:12px}
  .flex{display:flex;gap:12px;align-items:center}
  input, select, textarea, button{font-size:15px;padding:10px;border-radius:8px;border:1px solid #e6e8ee}
  button{cursor:pointer;background:var(--accent);color:#fff;border:none}
  .muted{color:var(--muted);font-size:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
  .user-card{display:flex;gap:12px;align-items:center;padding:12px;border-radius:14px}
  .user-card img{width:74px;height:74px;border-radius:12px;object-fit:cover}
  .actions{margin-left:auto;display:flex;flex-direction:column;gap:8px}
  .small-btn{background:#fff;color:var(--accent);border:1px solid #e6e8ee;padding:8px;border-radius:8px}
  #debug{font-family:monospace;font-size:13px;color:#333;white-space:pre-wrap;margin-top:10px;background:#fff;padding:10px;border-radius:8px;border:1px solid #eee}
  nav button{margin-right:8px}
  .hidden{display:none}
</style>
</head>
<body>

<header>
  <div class="logo">Infinity</div>
  <nav>
    <button id="nav-home">–ì–ª–∞–≤–Ω–∞—è</button>
    <button id="nav-profile">–ü—Ä–æ—Ñ–∏–ª—å</button>
    <button id="nav-chats">–ß–∞—Ç—ã</button>
    <button id="nav-favs">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
    <button id="nav-logout" class="hidden">–í—ã–π—Ç–∏</button>
  </nav>
</header>

<main>
  <!-- AUTH -->
  <section id="page-auth" class="card">
    <h2>–í—Ö–æ–¥</h2>
    <div class="flex" style="gap:10px;flex-wrap:wrap">
      <input id="loginName" placeholder="–ù–∏–∫–Ω–µ–π–º">
      <input id="loginPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
      <button id="btnLogin">–í–æ–π—Ç–∏</button>
      <button id="btnShowReg" class="small-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </div>

    <div id="regBox" class="muted" style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
      <div class="flex">
        <input id="regName" placeholder="–ù–∏–∫–Ω–µ–π–º">
        <input id="regPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <select id="regRole"><option>–°—Ç–∞—Ä—Ç–∞–ø–µ—Ä</option><option>–ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç</option><option>–î–∏–∑–∞–π–Ω–µ—Ä</option><option>–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥</option></select>
        <button id="btnReg">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <section id="page-main" class="card hidden">
    <div class="flex" style="align-items:flex-end">
      <div style="flex:1">
        <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏..." style="width:100%;">
      </div>
      <select id="filterRole" style="width:240px">
        <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
        <option>Back-end —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</option>
        <option>UI/UX –î–∏–∑–∞–π–Ω–µ—Ä</option>
        <option>Fullstack —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</option>
        <option>–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥</option>
      </select>
      <button id="btnRefresh" class="small-btn" style="background:#fff">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div id="usersList" class="grid" style="margin-top:12px"></div>
  </section>

  <!-- PROFILE -->
  <section id="page-profile" class="card hidden">
    <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
    <div id="profileBlock" class="muted"></div>
    <div style="margin-top:10px">
      <textarea id="profPortfolio" rows="4" placeholder="–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ ‚Äî —Ç–µ–∫—Å—Ç"></textarea><br>
      <input type="file" id="profFile"><button id="btnUploadFile" class="small-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª/—Ñ–æ—Ç–æ</button>
      <div style="margin-top:10px"><button id="btnSaveProfile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button></div>
    </div>
  </section>

  <!-- CHATS -->
  <section id="page-chats" class="card hidden">
    <h2>–ß–∞—Ç—ã</h2>
    <div id="chatList" class="grid"></div>
  </section>

  <!-- OPEN CHAT -->
  <section id="page-chat-open" class="card hidden">
    <h2 id="chatTitle">–ß–∞—Ç</h2>
    <div id="messagesBox" style="max-height:360px;overflow:auto;border:1px solid #eee;padding:12px;background:#fafafa;border-radius:8px"></div>
    <div class="flex" style="margin-top:10px">
      <input id="msgInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1">
      <button id="btnSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </section>

  <!-- FAVORITES -->
  <section id="page-favs" class="card hidden">
    <h2>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
    <div id="favList" class="grid"></div>
  </section>

  <div id="debug" class="card hidden"></div>
</main>

<script>
/*
  –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥:
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ API (username/name, password/pass, /users or /all_users)
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage
  - –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∏ –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –≤ –±–ª–æ–∫–µ #debug
*/

// ---- Helpers ----
const dbg = (text) => {
  const el = document.getElementById('debug');
  el.classList.remove('hidden');
  el.textContent = (el.textContent ? el.textContent + '\\n' : '') + text;
};

const tryJson = async (res) => {
  try { return await res.json(); } catch(e) { return null; }
};

// wrapper that tries fetch and returns {ok,res,data,text}
async function doFetch(url, opts){
  try{
    const res = await fetch(url, opts);
    const txt = await res.text().catch(()=>'');
    let data = null;
    try { data = JSON.parse(txt); } catch(e){ data = null; }
    return { ok: res.ok, status: res.status, data: data, text: txt };
  }catch(err){
    return { ok:false, err: String(err) };
  }
}

// ---- API adaptors: try multiple endpoint/field combos ----

async function apiRegister(name, pass, role){
  // try common variants in sequence
  const tries = [
    { url:'/register', body: { username:name, password:pass, role } },
    { url:'/register', body: { name:name, pass:pass, role } },
    { url:'/register', body: { username:name, pass:pass, role } },
    { url:'/register', body: { name:name, password:pass, role } },
  ];
  for(const t of tries){
    const r = await doFetch(t.url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(t.body) });
    if(r.ok){ dbg(`register -> ${t.url} OK`); return r.data || { ok:true }; }
    dbg(`register -> ${t.url} failed (${r.status||r.err})`);
  }
  return { error: 'All register attempts failed' };
}

async function apiLogin(name, pass){
  const tries = [
    { url:'/login', body:{ username:name, password:pass } },
    { url:'/login', body:{ name:name, pass:pass } },
    { url:'/login', body:{ username:name, pass:pass } },
    { url:'/login', body:{ name:name, password:pass } },
  ];
  for(const t of tries){
    const r = await doFetch(t.url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(t.body) });
    if(r.ok){ dbg(`login -> ${t.url} OK`); return r.data || { ok:true }; }
    dbg(`login -> ${t.url} failed (${r.status||r.err})`);
  }
  return { error:'All login attempts failed' };
}

async function apiGetUsers(){
  const urls = ['/all_users','/users','/profiles','/profiles/list','/profiles/'];
  for(const u of urls){
    const r = await doFetch(u, { method:'GET' });
    if(r.ok && r.data){
      dbg(`getUsers -> ${u} OK`);
      // some endpoints return object; normalize to array of {name,role,tech,avatar,portfolio,fav}
      let arr = r.data;
      if(!Array.isArray(arr)){
        // try to interpret object keyed by name -> info
        if(typeof arr === 'object'){
          arr = Object.keys(arr).map(k => {
            const v = arr[k] || {};
            return { name: v.name || v.username || k, role: v.role || '', tech: v.tech || '', avatar: v.avatar || '', portfolio: v.portfolio || [], fav: v.fav || [] };
          });
        } else arr = [];
      }
      return arr;
    }
    dbg(`getUsers -> ${u} failed`);
  }
  return [];
}

async function apiToggleFav(user, fav){
  const tries = [
    { url:'/toggle_fav', body:{ user, fav } },
    { url:'/fav_toggle', body:{ user, fav } },
    { url:'/favorite', body:{ user, target: fav } },
    { url:'/add_fav', body:{ username:user, item: fav } }
  ];
  for(const t of tries){
    const r = await doFetch(t.url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(t.body) });
    if(r.ok){ dbg(`toggleFav -> ${t.url} OK`); return r.data || { ok:true }; }
    dbg(`toggleFav -> ${t.url} failed`);
  }
  return { error:'toggle fav failed' };
}

async function apiGetMessages(){
  const tries = ['/messages','/msg','/messages/all','/get_messages'];
  for(const u of tries){
    const r = await doFetch(u,{method:'GET'});
    if(r.ok && r.data !== null){ dbg(`getMessages -> ${u} OK`); return r.data; }
  }
  return [];
}

async function apiSendMessage(from,to,text){
  const tries = [
    { url:'/messages', body:{ from, to, text } },
    { url:'/msg', body:{ from, to, text } },
    { url:'/send_message', body:{ from, to, text } }
  ];
  for(const t of tries){
    const r = await doFetch(t.url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(t.body) });
    if(r.ok){ dbg(`sendMessage -> ${t.url} OK`); return r.data || { ok:true }; }
  }
  return { error:'send failed' };
}

async function apiUploadFile(user, file){
  const tries = ['/add_photo','/upload','/add_file'];
  for(const u of tries){
    if(!file) continue;
    const form = new FormData();
    form.append('file', file);
    // some endpoints expect user_id or username
    form.append('username', user.name || user.username || user);
    form.append('user', user.name || user.username || user);
    const r = await doFetch(u, { method:'POST', body: form });
    if(r.ok){ dbg(`upload -> ${u} OK`); return r.data || { ok:true }; }
    dbg(`upload -> ${u} failed`);
  }
  return { error:'upload failed' };
}

// ---- UI logic ----

let currentUser = null;
let currentChatWith = null;

// navigation
const el = (id)=>document.getElementById(id);
el('btnReg').addEventListener('click', async ()=>{
  const name = el('regName').value.trim(), pass = el('regPass').value, role = el('regRole').value;
  if(!name || !pass) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
  const res = await apiRegister(name,pass,role) || await apiRegister(name,pass,role); // call wrapper
  if(res.error) return alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å: '+res.error);
  // some backends return user, some just ok
  if(res.user) currentUser = res.user;
  else currentUser = { name, role, fav: [] };
  localStorage.setItem('inf_current', JSON.stringify(currentUser));
  showMain();
});

el('btnLogin').addEventListener('click', async ()=>{
  const name = el('loginName').value.trim(), pass = el('loginPass').value;
  if(!name || !pass) return alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å');
  const res = await apiLogin(name,pass);
  if(res.error) return alert('–í—Ö–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è');
  currentUser = res.user || res || { name };
  if(typeof currentUser === 'string') currentUser = { name: currentUser };
  localStorage.setItem('inf_current', JSON.stringify(currentUser));
  showMain();
});

el('btnUploadFile').addEventListener('click', async ()=>{
  if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ');
  const file = el('profFile').files[0];
  const r = await apiUploadFile(currentUser, file);
  if(r.error) return alert('–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å');
  alert('–ó–∞–≥—Ä—É–∂–µ–Ω–æ');
});

el('btnSaveProfile').addEventListener('click', async ()=>{
  if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ');
  const text = el('profPortfolio').value;
  // try endpoints
  const tries = [
    { url:'/portfolio_text', body: { user_id: currentUser.id || currentUser.name || currentUser.username, text } },
    { url:'/portfolio_text', body: { text } },
    { url:'/profile_update', body: { name: currentUser.name, portfolio: text } }
  ];
  for(const t of tries){
    const r = await doFetch(t.url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(t.body) });
    if(r.ok){ dbg('profile saved via '+t.url); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); return; }
  }
  alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
});

// nav
el('nav-home').addEventListener('click', ()=> currentUser ? showMain() : showAuth());
el('nav-profile').addEventListener('click', ()=> currentUser ? showProfile() : showAuth());
el('nav-chats').addEventListener('click', ()=> currentUser ? showChats() : showAuth());
el('nav-favs').addEventListener('click', ()=> currentUser ? showFavs() : showAuth());
el('nav-logout').addEventListener('click', ()=>{ currentUser=null; localStorage.removeItem('inf_current'); showAuth(); });

// page controls
el('btnRefresh').addEventListener('click', ()=>renderUsers());
el('searchInput').addEventListener('input', ()=>renderUsers());
el('filterRole').addEventListener('change', ()=>renderUsers());
el('btnSend').addEventListener('click', ()=> {
  const text = el('msgInput').value.trim();
  if(!text) return;
  apiSendMessage(currentUser, currentChatWith, text).then(r=>{
    el('msgInput').value='';
    loadMessagesFor(currentChatWith);
  });
});

// show/hide pages
function hideAll(){ document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden')); }
function showAuth(){ hideAll(); el('page-auth').classList.remove('hidden'); el('nav-logout').classList.add('hidden'); }
function showMain(){ hideAll(); el('page-main').classList.remove('hidden'); el('nav-logout').classList.remove('hidden'); renderUsers(); }
function showProfile(){ hideAll(); el('page-profile').classList.remove('hidden'); el('nav-logout').classList.remove('hidden'); renderProfile(); }
function showChats(){ hideAll(); el('page-chats').classList.remove('hidden'); el('nav-logout').classList.remove('hidden'); renderChatList(); }
function showChatOpen(){ hideAll(); el('page-chat-open').classList.remove('hidden'); el('nav-logout').classList.remove('hidden'); }
function showFavs(){ hideAll(); el('page-favs').classList.remove('hidden'); el('nav-logout').classList.remove('hidden'); renderFavorites(); }

// render functions
async function renderUsers(){
  const container = el('usersList'); container.innerHTML = '';
  if(!currentUser) return;
  const all = await apiGetUsers();
  const q = el('searchInput').value.trim().toLowerCase();
  const roleFilter = el('filterRole').value;
  all.forEach(u=>{
    const name = u.name || u.username || u.login || '';
    const role = u.role || '';
    const tech = u.tech || (u.portfolio && (Array.isArray(u.portfolio)? u.portfolio.join(', '): u.portfolio)) || '';
    if(name === currentUser.name || name === currentUser.username) return;
    if(q && !(name.toLowerCase().includes(q) || (tech+'').toLowerCase().includes(q))) return;
    if(roleFilter && role !== roleFilter) return;

    const card = document.createElement('div'); card.className='user-card card';
    card.innerHTML = `
      <img src="${u.avatar || (u.avatarUrl || 'https://via.placeholder.com/120')}" alt="">
      <div>
        <div style="font-weight:600">${name}</div>
        <div class="muted">${role}</div>
        <div class="muted" style="font-size:13px">${tech}</div>
      </div>
      <div class="actions">
        <button class="small-btn" data-name="${name}" onclick="(async (e)=>{ e.stopPropagation(); const res=await apiToggleFav(currentUser.name||currentUser.username||currentUser, '${name}'); if(res.user){ currentUser = res.user; localStorage.setItem('inf_current', JSON.stringify(currentUser)); renderUsers(); renderFavorites(); } else alert('fav failed'); })(event)">‚ù§</button>
        <button class="small-btn" onclick="openChat('${name}')">üí¨</button>
      </div>
    `;
    container.appendChild(card);
  });
}

async function renderProfile(){
  const block = el('profileBlock'); block.innerHTML='';
  if(!currentUser) return;
  block.innerHTML = `<p><b>–ò–º—è:</b> ${currentUser.name || currentUser.username}</p>
    <p><b>–†–æ–ª—å:</b> ${currentUser.role || '‚Äî'}</p>
    <p class="muted">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏: ${currentUser.tech || '‚Äî'}</p>`;
  el('profPortfolio').value = currentUser.portfolio && (Array.isArray(currentUser.portfolio)? currentUser.portfolio.join('\\n') : currentUser.portfolio) || '';
}

async function renderChatList(){
  const box = el('chatList'); box.innerHTML='';
  const all = await apiGetUsers();
  all.forEach(u=>{
    const name = u.name || u.username || u.login;
    if(name === (currentUser.name||currentUser.username)) return;
    const card = document.createElement('div'); card.className='card'; card.textContent = name; card.onclick = ()=> openChat(name);
    box.appendChild(card);
  });
}

async function renderFavorites(){
  const box = el('favList'); box.innerHTML='';
  const favs = currentUser?.fav || [];
  if(!favs.length){ box.innerHTML = '<div class="muted">–ü—É—Å—Ç–æ</div>'; return; }
  const all = await apiGetUsers();
  favs.forEach(name=>{
    const u = all.find(x => (x.name||x.username||x.login) === name);
    if(!u) return;
    const card = document.createElement('div'); card.className='card'; card.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><img src="${u.avatar||'https://via.placeholder.com/72'}" style="width:72px;height:72px;border-radius:8px"><div><b>${name}</b><div class="muted">${u.role||''}</div></div></div>`;
    box.appendChild(card);
  });
}

// Chat
async function openChat(name){
  currentChatWith = name;
  el('chatTitle').textContent = '–ß–∞—Ç —Å ' + name;
  showChatOpen();
  await loadMessagesFor(name);
}

async function loadMessagesFor(name){
  const box = el('messagesBox'); box.innerHTML='';
  const all = await apiGetMessages();
  (all||[]).filter(m => (m.from === (currentUser.name||currentUser.username) && m.to === name) || (m.to === (currentUser.name||currentUser.username) && m.from === name))
    .forEach(m => {
      const d = document.createElement('div'); d.className = 'message ' + (m.from === (currentUser.name||currentUser.username) ? 'me' : 'other'); d.textContent = m.text;
      box.appendChild(d);
    });
  box.scrollTop = box.scrollHeight;
}

// send wrapper uses apiSendMessage
async function sendMessage(){
  const text = el('msgInput').value.trim();
  if(!text) return;
  await apiSendMessage(currentUser.name||currentUser.username, currentChatWith, text);
  el('msgInput').value=''; loadMessagesFor(currentChatWith);
}

// --- init
(function init(){
  const saved = localStorage.getItem('inf_current');
  if(saved){
    try{ currentUser = JSON.parse(saved); }catch(e){ currentUser = null; }
  }
  if(currentUser) showMain(); else showAuth();
})();

</script>
</body>
</html>

